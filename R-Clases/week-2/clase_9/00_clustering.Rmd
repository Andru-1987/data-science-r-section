# [Clustering Kmeans Wines](https://domino.ai/blog/clustering-in-r)

# Challenge del desafio final -> Enunciado final
```{R import-librerias}
wineUrl <- 'http://archive.ics.uci.edu/ml/machine-learning-databases/wine/wine.data'
column_names <- c('Cultivo', 'Alcohol', 'Malic.acid','Ash', 'Alcalinity.of.ash','Magnesium', 'Total.phenols','Flavanoids', 'Nonflavanoid.phenols','Proanthocyanin', 'Color.intensity','Hue', 'OD280.OD315.of.diluted.wines','Proline')
# retiramos la columna Cultivo -> pues es el campo que nos va a dar su sector o segmento.
wine_raw <- read.table(wineUrl, header=FALSE, sep=',', stringsAsFactors=FALSE, col.names=column_names) %>% as_tibble()

# Separar target y features
wine_target <- wine_raw %>% select(Cultivo)
wine_features <- wine_raw %>% select(-Cultivo)

glimpse(wine_raw)
write.csv(wine_raw, "wine.data.csv")
```
## Conteo de nulls
```{R}
# Conteo de valores NA por columna
na_counts <- sapply(wine_features, function(x) sum(is.na(x)))

# Mostrar como tibble
na_counts_tbl <- tibble(Columna = names(na_counts), NA_Count = as.integer(na_counts))
na_counts_tbl
```
```{R}

library(tidymodels)
library(broom)
library(dplyr)

# 1. Preparar los datos
set.seed(42)
wine_split <- initial_split(wine_features, prop = 0.8)
wine_train <- training(wine_split)

# 2. Preprocesamiento con recipe
wine_recipe <- recipe(~ ., data = wine_train) %>%
  step_normalize(all_predictors())

# 3. Preparar los datos procesados
prep_wine <- prep(wine_recipe)
wine_train_prepped <- bake(prep_wine, new_data = NULL)

# 4. Aplicar k-means directamente
kmeans_model <- kmeans(wine_train_prepped, centers = 3)

# 5. Extraer resultados tidy
kmeans_tidy <- tidy(kmeans_model)       # centros
kmeans_glance <- glance(kmeans_model)   # métricas
kmeans_augmented <- augment(kmeans_model, wine_train_prepped)  # asignaciones

# 6. Añadir cluster al dataset original
wine_clustered <- wine_train %>%
  bind_cols(cluster = kmeans_augmented$.cluster)

```
```{R}
dependencies <- c("tidymodels", "cluster", "factoextra", "mclust")
install.packages(setdiff(dependencies,installed.packages()))


library(tidyverse)
library(tidymodels)
library(cluster)
library(factoextra)
library(recipes)

# 1. Cargar el dataset
wine <- read_csv("wine.data.csv", col_names = FALSE)
colnames(wine) <- c('Cultivo', 'Alcohol', 'Malic.acid','Ash', 'Alcalinity.of.ash','Magnesium',
                    'Total.phenols','Flavanoids', 'Nonflavanoid.phenols','Proanthocyanin',
                    'Color.intensity','Hue', 'OD280.OD315.of.diluted.wines','Proline')

# 2. Separar features y target
wine_features <- wine %>% select(-Cultivo)
wine_target <- wine %>% select(Cultivo)

# 3. Preprocesamiento con recipe
wine_recipe <- recipe(~ ., data = wine_features) %>%
  step_normalize(all_predictors())

wine_prep <- prep(wine_recipe)
wine_scaled <- bake(wine_prep, new_data = NULL)

# 4. Método del codo para KMeans
fviz_nbclust(wine_scaled, kmeans, method = "wss") +
  labs(title = "Método del Codo para KMeans")

# 5. KMeans con 3 clusters
set.seed(42)
kmeans_model <- kmeans(wine_scaled, centers = 3)
fviz_cluster(kmeans_model, data = wine_scaled, geom = "point", ellipse.type = "convex") +
  labs(title = "KMeans Clustering")

# 6. Silhouette Score para KMeans
kmeans_sil <- silhouette(kmeans_model$cluster, dist(wine_scaled))
fviz_silhouette(kmeans_sil) +
  labs(title = "Silhouette KMeans")

# 7. GMM con 3 componentes
library(mclust)
gmm_model <- Mclust(wine_scaled, G = 3)
fviz_cluster(list(data = wine_scaled, cluster = gmm_model$classification)) +
  labs(title = "GMM Clustering")

# 8. Silhouette Score para GMM
gmm_sil <- silhouette(gmm_model$classification, dist(wine_scaled))
fviz_silhouette(gmm_sil) +
  labs(title = "Silhouette GMM")

```
```{R}

# Instalar paquetes si no están presentes
packages <- c("tidyverse", "plotly", "mclust", "cluster", "factoextra")
install.packages(setdiff(dependencies,installed.packages()))


# Cargar librerías
library(tidyverse)
library(plotly)
library(mclust)
library(cluster)
library(factoextra)

# Cargar dataset

wineUrl <- 'http://archive.ics.uci.edu/ml/machine-learning-databases/wine/wine.data'
column_names <- c('Cultivo', 'Alcohol', 'Malic.acid','Ash', 'Alcalinity.of.ash','Magnesium', 'Total.phenols','Flavanoids', 'Nonflavanoid.phenols','Proanthocyanin', 'Color.intensity','Hue', 'OD280.OD315.of.diluted.wines','Proline')
# retiramos la columna Cultivo -> pues es el campo que nos va a dar su sector o segmento.
wine <- read.table(wineUrl, header=FALSE, sep=',', stringsAsFactors=FALSE, col.names=column_names) %>% as_tibble()


# Separar features
wine_features <- wine %>% select(-Cultivo)

# Estandarizar
wine_scaled <- scale(wine_features)

# PCA a 3 componentes
pca_3d <- prcomp(wine_scaled, center = TRUE, scale. = TRUE)
pca_data <- as_tibble(pca_3d$x[, 1:3])

# KMeans clustering
set.seed(42)
kmeans_model <- kmeans(pca_data, centers = 3)
pca_data$cluster_kmeans <- as.factor(kmeans_model$cluster)

# GMM clustering
gmm_model <- Mclust(pca_data[, 1:3], G = 3)
pca_data$cluster_gmm <- as.factor(gmm_model$classification)

# Visualización 3D interactiva con plotly
plot_kmeans <- plot_ly(pca_data, x = ~PC1, y = ~PC2, z = ~PC3,
                       color = ~cluster_kmeans, colors = "Viridis",
                       type = "scatter3d", mode = "markers") %>%
  layout(title = "KMeans Clustering (PCA 3D)")


plot_gmm <- plot_ly(pca_data, x = ~PC1, y = ~PC2, z = ~PC3,
                    color = ~cluster_gmm, # colors = "Inferno",  # <- corregido aquí
                    type = "scatter3d", mode = "markers") %>%
  layout(title = "GMM Clustering (PCA 3D)")

# Mostrar ambos
plot_kmeans
plot_gmm


# Guardar modelos en archivos RDS
saveRDS(kmeans_model, "R-Clases/week-2/clase_9/models/modelo_kmeans.rds")
saveRDS(gmm_model, "R-Clases/week-2/clase_9/models/modelo_gmm.rds")
saveRDS(pca_3d, "R-Clases/week-2/clase_9/models/modelo_pca.rds")


```
```{R}
```
```{R}
```