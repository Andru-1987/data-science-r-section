---
title: "Random Forest Loan Challenge"
author: "Anderson Ocaña"
date: "`r Sys.Date()`"
output: html_document
---

```{R import-data}
library(themis)
library(dials)
```

```{R load-data}
loan_dataset_path <- "R-Clases/week-2/clase_10/storage/loan_status.csv"
loan_dataset <- read.csv(loan_dataset_path, sep = ",")


loan_dataset <- loan_dataset %>% 
    select(-Loan_ID) %>%
    mutate(across(where( ~!is.numeric(.)), as.factor)) %>%
    drop_na


glimpse(loan_dataset)
```


```{R plot-target}
target_counts <- loan_dataset %>%
    count(Loan_Status) %>%
    mutate( percent = n /sum(n) * 100)


target_counts

ggplot(target_counts, aes(x=2,y=n,fill=Loan_Status))+
    geom_bar(stat="identity", width=1,color="white")+
    coord_polar(theta = "y") +
    xlim(0.5,2.5) +
    theme(legend.position = "right")

```



```{R splitting-data}

split <- initial_split(loan_dataset, prop = 0.75, strata = Loan_Status)

train_data <- training(split) 
test_data <- testing(split)
```


```{R recipes-data}
loan_recipe <- 
    recipe(Loan_Status ~ ., data=train_data) %>%
    step_impute_median(all_numeric_predictors()) %>%
    step_impute_mode(all_nominal_predictors()) %>%
    step_dummy(all_nominal_predictors()) %>%
    step_zv(all_predictors()) %>%
    step_upsample(Loan_Status)



loan_recipe_prep <- prep(loan_recipe)
loan_recipe_processed <- bake(loan_recipe_prep ,new_data = NULL)

glimpse(loan_recipe_processed)
summary(loan_recipe_processed)

```


```{R pick-model}

rf_model <- rand_forest(
    mtry = tune(),
    trees = 50,
    min_n = tune()
) %>%
set_engine("ranger",importance = "impurity", verbose=TRUE) %>%
set_mode("classification")

```


```{R workflow}

rf_workflow <- workflow() %>%
    add_recipe(loan_recipe) %>%
    add_model(rf_model)


rf_workflow

```


```{R cross-validation-hypertunning}
library(tidymodels)


# Create cross-validation folds
cv_folds <- vfold_cv(train_data, v = 5, strata = Loan_Status)

# Definir grid de hiperparámetros para afinar
rf_params <- parameters(rf_model) %>%
  finalize(train_data) # o finalize(select(train_data, -Loan_Status))

# Alternativamente, si quieres sólo ajustar mtry
rf_params <- finalize(
  parameters(mtry(), min_n()),
  train_data
)


rf_tune <- tune_bayes(
  rf_workflow,
  resamples = cv_folds,
  param_info = rf_params,  # <- Aquí especificas el rango finalizado
  initial = 10,
  metrics = metric_set(roc_auc, accuracy, precision),
  iter = 15,
  control = control_bayes(
    verbose = TRUE,
    no_improve = 5
  )
)

# View results
rf_tune %>% collect_metrics() %>% arrange(desc(mean))
```

```{R search_best_params}

best_params <- select_best(rf_tune, metric="roc_auc")

final_rf <- finalize_workflow(rf_workflow, best_params) %>% fit(data = train_data)

final_rf
```




```{R testing}

true_value <- "Y"

rf_pred <- predict(final_rf, test_data, type = "prob") %>%
    bind_cols( test_data %>% select(Loan_Status))

rf_pred
```

```{R test-value-report}
library(yardstick)

# Definir conjunto de métricas incluyendo roc_auc
grid_metricas <- metric_set(roc_auc, accuracy, f_meas, precision, recall)

threshold <- 0.3

# Predicciones
rf_pred <- predict(final_rf, test_data, type = "prob") %>%
    bind_cols(test_data %>% select(Loan_Status)) %>%
    mutate(
        .pred_class = factor(ifelse(.pred_Y > threshold, "Y", "N"),
                             levels = c("N", "Y"))
    )

    

# Calcular métricas
rf_metrics <- grid_metricas(
    rf_pred,
    truth = Loan_Status,      # Variable real
    estimate = .pred_class,   # Para métricas de clase
    .pred_N                   # Para roc_auc, se pasa prob de clase positiva
)

rf_metrics
```


```{R save-model}
saveRDS(final_rf, "R-Clases/week-2/clase_10/models/rf_model.rds")
```



